<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenShift Regional Disaster Recovery with Advanced Cluster Management :: OCS Training</title>
    <link rel="canonical" href="https://red-hat-storage.github.io/ocs-training/training/ocs4/odf410-multisite-ramen.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LGCEEZGN54"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-LGCEEZGN54')</script>
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="40px" alt="Red Hat Data Services">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">OCS Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/blob/master/CONTRIBUTING.adoc" target="_blank">Guidelines</a>
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OCS Installation and Configuration</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf.html">ODF General deploy and use</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-install-no-ui.html">OCS CLI based install</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-install-no-ui.html">ODF CLI based install</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-encryption.html">External KMS Encryption</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-enable-rgw.html">Use RGW in OCS deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-cluster-storage-quotas.html">Cluster wide storage management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Disaster recovery</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-multisite-ramen.html">ODF 4.9 Regional disaster recovery</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="odf410-multisite-ramen.html">ODF 4.10 Regional disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-metro-stretched.html">Stretch Cluster disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-metro-ramen.html">ODF 4.10 Metro disaster recovery</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Development preview features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-dbwal.html">BlueStore RocksDB metadata and WAL placement</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-devtype.html">Mixed OSD device type configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-override.html">Ceph configuration override</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-segregation.html">Data Segregation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../infra-nodes/ocs4-infra-nodes.html">Deploying on Infra nodes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4perf/ocs4perf.html">Test deployment post-install</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Installation and Configuration</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OCS Installation and Configuration</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../RegionalDR/index.html">ODF Regional DR</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../RegionalDR/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Installation and Configuration</a></li>
    <li>Disaster recovery</li>
    <li><a href="odf410-multisite-ramen.html">ODF 4.10 Regional disaster recovery</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/red-hat-storage/ocs-training/edit/master/training/modules/ocs4/pages/odf410-multisite-ramen.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">OpenShift Regional Disaster Recovery with Advanced Cluster Management</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">1. Overview</a></li>
<li><a href="#_deploy_and_configure_acm_for_multisite_connectivity">2. Deploy and Configure ACM for Multisite connectivity</a>
<ul class="sectlevel2">
<li><a href="#_install_acm_and_multiclusterhub">2.1. Install ACM and MultiClusterHub</a></li>
<li><a href="#_import_or_create_managed_clusters">2.2. Import or Create Managed clusters</a></li>
<li><a href="#_verify_managed_clusters_have_non_overlapping_networks">2.3. Verify Managed clusters have non-overlapping networks</a></li>
<li><a href="#_connect_the_managed_clusters_using_submariner_add_ons">2.4. Connect the Managed clusters using Submariner add-ons</a></li>
</ul>
</li>
<li><a href="#_openshift_data_foundation_installation">3. OpenShift Data Foundation Installation</a></li>
<li><a href="#_install_openshift_dr_hub_operator_on_hub_cluster">4. Install OpenShift DR Hub Operator on Hub cluster</a></li>
<li><a href="#_configuring_multisite_storage_replication">5. Configuring Multisite Storage Replication</a>
<ul class="sectlevel2">
<li><a href="#_install_odf_multicluster_orchestrator">5.1. Install ODF Multicluster Orchestrator</a></li>
<li><a href="#_create_mirror_peer_on_hub_cluster">5.2. Create Mirror Peer on Hub cluster</a></li>
<li><a href="#_validate_mirroring_on_managed_clusters">5.3. Validate Mirroring on Managed clusters</a></li>
<li><a href="#_validate_object_buckets_and_s3storeprofiles">5.4. Validate Object Buckets and s3StoreProfiles</a></li>
</ul>
</li>
<li><a href="#_create_mirroring_storageclass_resource">6. Create Mirroring StorageClass resource</a></li>
<li><a href="#_configure_ssl_access_between_s3_endpoints">7. Configure SSL access between S3 endpoints</a></li>
<li><a href="#_create_drpolicy_on_hub_cluster">8. Create DRPolicy on Hub cluster</a></li>
<li><a href="#_enable_automatic_install_of_odr_cluster_operator">9. Enable Automatic Install of ODR Cluster operator</a></li>
<li><a href="#_create_s3_secrets_on_managed_clusters">10. Create S3 Secrets on Managed clusters</a></li>
<li><a href="#_create_sample_application_for_dr_testing">11. Create Sample Application for DR testing</a>
<ul class="sectlevel2">
<li><a href="#_create_drplacementcontrol_resource">11.1. Create DRPlacementControl resource</a></li>
<li><a href="#_create_placementrule_resource">11.2. Create PlacementRule resource</a></li>
<li><a href="#_creating_sample_application_using_acm_console">11.3. Creating Sample Application using ACM console</a></li>
<li><a href="#_validating_sample_application_deployment_and_replication">11.4. Validating Sample Application deployment and replication</a></li>
<li><a href="#_deleting_the_sample_application">11.5. Deleting the Sample Application</a></li>
</ul>
</li>
<li><a href="#_application_failover_between_managed_clusters">12. Application Failover between managed clusters</a></li>
<li><a href="#_application_failback_between_managed_clusters">13. Application Failback between managed clusters</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The intent of this guide is to detail the steps and commands necessary to be able to failover an application from one <code>OpenShift Container Platform</code> (OCP) cluster to another and then failback the same application to the original <strong>primary cluster</strong>. In this case the OCP clusters will be created or imported using <strong>Red Hat Advanced Cluster Management</strong> or <code>RHACM</code>.</p>
</div>
<div class="paragraph">
<p>This is a general overview of the steps required to configure and execute <code>OpenShift Disaster Recovery</code> (ODR) capabilities using OpenShift Data Foundation (ODF) <strong>v4.10</strong> and <code>RHACM</code> <strong>v2.4</strong> across two distinct OCP clusters separated by distance. In addition to these two cluster called <code>managed</code> clusters, there is currently a requirement to have a third OCP cluster that will be the <code>Advanced Cluster Management</code> (ACM) <code>hub</code> cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These steps are considered Tech Preview in ODF 4.10 and are provided for POC (Proof of Concept) purposes. OpenShift <code>Regional Disaster Recovery</code> will be supported for production usage in a future ODF release.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p><strong>Install the ACM operator on the hub cluster.</strong><br>
After creating the OCP hub cluster, install from OperatorHub the ACM operator. After the operator and associated pods are running, create the MultiClusterHub resource.</p>
</li>
<li>
<p><strong>Create or import managed OCP clusters into ACM hub.</strong><br>
Import or create the two managed clusters with adequate resources for ODF (compute nodes, memory, cpu) using the RHACM console.</p>
</li>
<li>
<p><strong>Ensure clusters have unique private network address ranges.</strong><br>
Ensure the primary and secondary OCP clusters have unique private network address ranges.</p>
</li>
<li>
<p><strong>Connect the private networks using Submariner add-ons.</strong><br>
Connect the managed OCP private networks (cluster and service) using the RHACM Submariner add-ons.</p>
</li>
<li>
<p><strong>Install ODF 4.10 on managed clusters.</strong><br>
Install ODF 4.10 on primary and secondary OCP managed clusters and validate deployment.</p>
</li>
<li>
<p><strong>Install ODR Hub Operator on the ACM hub cluster.</strong><br>
Install from OperatorHub on the ACM hub cluster the ODR Hub Operator.</p>
</li>
<li>
<p><strong>Install ODF Multicluster-orchestrator operator on ACM hub cluster.</strong><br>
Using OperatorHub on ACM hub cluster install the multicluster orchestrator operator.</p>
</li>
<li>
<p><strong>Install Mirror Peer resource on ACM hub cluster.</strong><br>
Using the multicluster orchestrator operator, install the MirrorPeer resource using CLI or the operator wizard.</p>
</li>
<li>
<p><strong>Validate Ceph mirroring is active between managed OCP clusters.</strong><br>
Using CLI, validate the new rbd-mirroring pods are created in each managed cluster and that the default CephBlockPool has healthy mirroring status in both directions.</p>
</li>
<li>
<p><strong>Validate Object Buckets and s3StoreProfiles.</strong><br>
Using CLI, validate that new MCG object buckets are created on the managed clusters including new secrets stored in the hub cluster and s3StoreProfiles added to the ramen config map.</p>
</li>
<li>
<p><strong>Create new mirroring StorageClass resource.</strong><br>
Using CLI, create new StorageClass with correct image features for block volumes enabled for mirroring.</p>
</li>
<li>
<p><strong>Configure SSL access between managed clusters if (if needed).</strong><br>
For each managed cluster extract the ingress certificate and inject into the alternate cluster for MCG object bucket secure access.</p>
</li>
<li>
<p><strong>Create the DRPolicy resource on the hub cluster.</strong><br>
DRPolicy is an API available after the ODR Hub Operator is installed. It is used to deploy, failover, and relocate, workloads across managed clusters.</p>
</li>
<li>
<p><strong>Enable Automatic Install of ODR Cluster operator.</strong><br>
Enable the ODR Cluster operator to be installed from the hub cluster to the managed cluster by setting deploymentAutomationEnabled=true in the ramen config map.</p>
</li>
<li>
<p><strong>Create S3 secrets on managed clusters.</strong><br>
Copy the S3 secrets on hub cluster to YAML files. Create both secrets on the managed clusters.</p>
</li>
<li>
<p><strong>Create the Sample Application namespace on the hub cluster.</strong><br>
Because the ODR Hub Operator APIs are namespace scoped, the sample application namespace must be created first.</p>
</li>
<li>
<p><strong>Create the DRPlacementControl resource on the hub cluster.</strong><br>
DRPlacementControl is an API available after the ODR Hub Operator is installed.</p>
</li>
<li>
<p><strong>Create the PlacementRule resource on the hub cluster.</strong><br>
Placement rules define the target clusters where resource templates can be deployed.</p>
</li>
<li>
<p><strong>Create the Sample Application using ACM console.</strong><br>
Use the sample app example from <a href="https://github.com/RamenDR/ocm-ramen-samples" class="bare">github.com/RamenDR/ocm-ramen-samples</a> to create a busybox deployment for failover and failback testing.</p>
</li>
<li>
<p><strong>Validate Sample Application deployment and alternate cluster replication</strong><br>
Using CLI commands on both managed clusters validate that the application is running and that the volume was replicated to the alternate cluster.</p>
</li>
<li>
<p><strong>Failover Sample Application to secondary managed cluster.</strong><br>
Using the application DRPlacementControl resource on the Hub Cluster, add the action of Failover and specify the failoverCluster to trigger the failover.</p>
</li>
<li>
<p><strong>Failback Sample Application to primary managed cluster.</strong><br>
Using the application DRPlacementControl resource on the Hub Cluster, modify the action to Relocate and trigger failover to  the preferredCluster.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_and_configure_acm_for_multisite_connectivity"><a class="anchor" href="#_deploy_and_configure_acm_for_multisite_connectivity"></a>2. Deploy and Configure ACM for Multisite connectivity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This installation method requires you have three OpenShift clusters that have network reachability between them. For the purposes of this document we will use this reference for the clusters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Hub cluster</strong> is where ACM, ODF Multisite-orchestrator and ODR Hub controllers are installed.</p>
</li>
<li>
<p><strong>Primary managed cluster</strong> is where ODF, ODR Cluster controller, and Applications are installed.</p>
</li>
<li>
<p><strong>Secondary managed cluster</strong> is where ODF, ODR Cluster controller, and Applications are installed.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_install_acm_and_multiclusterhub"><a class="anchor" href="#_install_acm_and_multiclusterhub"></a>2.1. Install ACM and MultiClusterHub</h3>
<div class="paragraph">
<p>Find ACM in OperatorHub on the <strong>Hub cluster</strong> and follow instructions to install this operator.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-OperatorHub.png" alt="OperatorHub filter for Advanced Cluster Management">
</div>
<div class="title">Figure 1. OperatorHub filter for Advanced Cluster Management</div>
</div>
<div class="paragraph">
<p>Verify that the operator was successfully installed and that the <code>MultiClusterHub</code> is ready to be installed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-Installed-Operator.png" alt="ACM Installed Operator">
</div>
<div class="title">Figure 2. ACM Installed Operator</div>
</div>
<div class="paragraph">
<p>Select <code>MultiClusterHub</code> and use either <code>Form view</code> or <code>YAML view</code> to configure the deployment and select <code>Create</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most <strong>MultiClusterHub</strong> deployments can use default settings in the <code>Form view</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the deployment is complete you can logon to the ACM console using your OpenShift credentials.</p>
</div>
<div class="paragraph">
<p>First, find the <strong>Route</strong> that has been created for the ACM console:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get route multicloud-console -n open-cluster-management -o jsonpath --template="https://{.spec.host}/multicloud/clusters{'\n'}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return a route similar to this one.</p>
</div>
<div class="listingblock">
<div class="title">Example Output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">https://multicloud-console.apps.perf3.example.com/multicloud/clusters</code></pre>
</div>
</div>
<div class="paragraph">
<p>After logging in you should see your local cluster imported.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-local-cluster-import.png" alt="ACM local cluster imported">
</div>
<div class="title">Figure 3. ACM local cluster imported</div>
</div>
</div>
<div class="sect2">
<h3 id="_import_or_create_managed_clusters"><a class="anchor" href="#_import_or_create_managed_clusters"></a>2.2. Import or Create Managed clusters</h3>
<div class="paragraph">
<p>Now that ACM is installed on the <code>Hub cluster</code> it is time to either create or import the <code>Primary managed cluster</code> and the <code>Secondary managed cluster</code>. You should see selections (as in above diagram) for <strong>Create cluster</strong> and <strong>Import cluster</strong>. Chose the selection appropriate for your environment. After the managed clusters are successfully created or imported you should see something similar to below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-managed-clusters-import.png" alt="ACM managed cluster imported">
</div>
<div class="title">Figure 4. ACM managed cluster imported</div>
</div>
</div>
<div class="sect2">
<h3 id="_verify_managed_clusters_have_non_overlapping_networks"><a class="anchor" href="#_verify_managed_clusters_have_non_overlapping_networks"></a>2.3. Verify Managed clusters have non-overlapping networks</h3>
<div class="paragraph">
<p>In order to connect the OpenShift cluster and service networks using the <code>Submariner add-ons</code>, it is necessary to validate the two clusters have non-overlapping networks. This can be done by running the following command for each of the managed clusters.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get networks.config.openshift.io cluster -o json | jq .spec</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output for ocp4perf1:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "clusterNetwork": [
    {
      "cidr": "10.5.0.0/16",
      "hostPrefix": 23
    }
  ],
  "externalIP": {
    "policy": {}
  },
  "networkType": "OpenShiftSDN",
  "serviceNetwork": [
    "10.15.0.0/16"
  ]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output for ocp4perf2:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "clusterNetwork": [
    {
      "cidr": "10.6.0.0/16",
      "hostPrefix": 23
    }
  ],
  "externalIP": {
    "policy": {}
  },
  "networkType": "OpenShiftSDN",
  "serviceNetwork": [
    "10.16.0.0/16"
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These outputs show that the two example managed clusters have non-overlapping <code>clusterNetwork</code> and <code>serviceNetwork</code> ranges so it is safe to proceed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_connect_the_managed_clusters_using_submariner_add_ons"><a class="anchor" href="#_connect_the_managed_clusters_using_submariner_add_ons"></a>2.4. Connect the Managed clusters using Submariner add-ons</h3>
<div class="paragraph">
<p>Now that we know the <code>cluster</code> and <code>service</code> networks have non-overlapping ranges, it is time to move on to installing the <code>Submariner add-ons</code> for each managed cluster. This is done by using the ACM console and <code>Cluster sets</code>.</p>
</div>
<div class="paragraph">
<p>Navigate to selection shown below and at the bottom of the same page, select <strong>Create cluster set</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-Cluster-sets.png" alt="ACM Create new Cluster set">
</div>
<div class="title">Figure 5. ACM Create new Cluster set</div>
</div>
<div class="paragraph">
<p>Once the new <code>Cluster set</code> is created select <strong>Manage resource assignments</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-Cluster-set-created.png" alt="ACM Cluster set created">
</div>
<div class="title">Figure 6. ACM Cluster set created</div>
</div>
<div class="paragraph">
<p>Follow the instructions and add the two managed clusters to the new <code>Cluster set</code>. Select <code>Save</code> and then navigate to <code>Submariner add-ons</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-Submariner-addon.png" alt="ACM Submariner add-ons">
</div>
<div class="title">Figure 7. ACM Submariner add-ons</div>
</div>
<div class="paragraph">
<p>Select <strong>Install Submariner add-ons</strong> at the bottom of the page and add the two managed clusters. Click through the wizard selections and make changes as needed. After <code>Review</code> of your selections select <strong>Install</strong>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It can take more than 5 minutes for the Submariner add-ons installation to finish on both managed clusters. Resources are installed in the <code>submariner-operator</code> project.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A successful deployment will show <code>Connection status</code> and <code>Agent status</code> as <code>Healthy</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-Submariner-addon-installed.png" alt="ACM Submariner add-ons installed">
</div>
<div class="title">Figure 8. ACM Submariner add-ons installed</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_openshift_data_foundation_installation"><a class="anchor" href="#_openshift_data_foundation_installation"></a>3. OpenShift Data Foundation Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to configure storage replication between the two OCP clusters <code>OpenShift Data Foundation</code> (ODF) must be installed first on each managed cluster. ODF deployment guides and instructions are specific to your infrastructure (i.e. AWS, VMware, BM, Azure, etc.). Install ODF version <strong>4.9</strong> or greater on both OCP managed clusters.</p>
</div>
<div class="paragraph">
<p>You can validate the successful deployment of ODF on each managed OCP cluster with the following command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get storagecluster -n openshift-storage ocs-storagecluster -o jsonpath='{.status.phase}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>And for the Multi-Cluster Gateway (MCG):</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get noobaa -n openshift-storage noobaa -o jsonpath='{.status.phase}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the result is <code>Ready</code> for both queries on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong> continue on to configuring mirroring.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The successful installation of ODF can also be validated in the <strong>OCP Web Console</strong> by navigating to <strong>Storage</strong> and then <strong>Data Foundation</strong>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_openshift_dr_hub_operator_on_hub_cluster"><a class="anchor" href="#_install_openshift_dr_hub_operator_on_hub_cluster"></a>4. Install OpenShift DR Hub Operator on Hub cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On the <strong>Hub cluster</strong> navigate to <strong>OperatorHub</strong> and filter for <code>OpenShift DR Hub Operator</code>. Follow instructions to <strong>Install</strong> the operator into the project <code>openshift-dr-system</code>.</p>
</div>
<div class="paragraph">
<p>Check to see the operator <strong>Pod</strong> is in a <code>Running</code> state.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods -n openshift-dr-system</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                 READY   STATUS    RESTARTS   AGE
ramen-hub-operator-898c5989b-96k65   2/2     Running   0          4m14s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_multisite_storage_replication"><a class="anchor" href="#_configuring_multisite_storage_replication"></a>5. Configuring Multisite Storage Replication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mirroring or replication is enabled on a per <code>CephBlockPool</code> basis within peer managed clusters and can then be configured on a specific subset of images within the pool. The <code>rbd-mirror</code> daemon is responsible for replicating image updates from the local peer cluster to the same image in the remote cluster.</p>
</div>
<div class="paragraph">
<p>These instructions detail how to create the mirroring relationship between two ODF managed clusters.</p>
</div>
<div class="sect2">
<h3 id="_install_odf_multicluster_orchestrator"><a class="anchor" href="#_install_odf_multicluster_orchestrator"></a>5.1. Install ODF Multicluster Orchestrator</h3>
<div class="paragraph">
<p>This is a controller that will be installed from OCP <strong>OperatorHub</strong> on the <strong>Hub cluster</strong>.</p>
</div>
<div class="paragraph">
<p>Navigate to <strong>OperatorHub</strong> on the <strong>Hub cluster</strong> and filter for <code>odf multicluster orchestrator</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODF-multicluster-orchestrator.png" alt="OperatorHub filter for ODF Multicluster Orchestrator">
</div>
<div class="title">Figure 9. OperatorHub filter for ODF Multicluster Orchestrator</div>
</div>
<div class="paragraph">
<p>Keep all default settings and <strong>Install</strong> this operator.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODF-multicluster-orchestrator-install.png" alt="ODF Multicluster Orchestrator install">
</div>
<div class="title">Figure 10. ODF Multicluster Orchestrator install</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The operator resources will be installed in <code>openshift-operators</code> and available to all namespaces.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Validate successful installation by having the ability to select <code>View Operator</code>. This means the installation has completed and the operator <strong>Pod</strong> should be <code>Running</code>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods -n openshift-operators</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                        READY   STATUS    RESTARTS   AGE
odfmo-controller-manager-65946fb99b-779v8   1/1     Running   0          5m3s</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_mirror_peer_on_hub_cluster"><a class="anchor" href="#_create_mirror_peer_on_hub_cluster"></a>5.2. Create Mirror Peer on Hub cluster</h3>
<div class="paragraph">
<p><strong>Mirror Peer</strong> is a cluster-scoped resource to hold information about the managed clusters that will have a <code>peering</code> relationship.</p>
</div>
<div class="paragraph">
<p>The job of the <code>Multicluster Orchestrator</code> controller and the <code>MirrorPeer</code> Custom Resource, is to do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a bootstrap token and exchanges this token between the managed clusters.</p>
</li>
<li>
<p>Enable mirroring for the default <code>CephBlockPool</code> on each managed clusters.</p>
</li>
<li>
<p>Create an object bucket (using MCG) on each managed cluster for mirrored <strong>PVC</strong> and <strong>PV</strong> metadata.</p>
</li>
<li>
<p>Create a <strong>Secret</strong> in the <code>openshift-dr-system</code> project on the <strong>Hub cluster</strong> for each new object bucket that has the base64 encoded access keys.</p>
</li>
<li>
<p>Create a <strong>VolumeReplicationClass</strong> on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</li>
<li>
<p>Modify the <code>ramen-hub-operator-config</code> <strong>ConfigMap</strong> on the <strong>Hub cluster</strong> and add the <code>s3StoreProfiles</code> entries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Requirements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Must be installed on <code>Hub cluster</code> after the <code>ODF Multicluster Orchestrator</code> is installed on <code>Hub cluster</code>.</p>
</li>
<li>
<p>There can only be two clusters per Mirror Peer.</p>
</li>
<li>
<p>Each cluster should be uniquely identifiable in ACM by cluster name (i.e., ocp4perf1).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After selecting <code>View Operator</code> in prior step you should see the <code>Mirror Peer</code> API. Select <strong>Create instance</strong> and then select <strong>YAML view</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODF-mirror-peer-yaml.png" alt="Create Mirror Peer in YAML view">
</div>
<div class="title">Figure 11. Create Mirror Peer in YAML view</div>
</div>
<div class="paragraph">
<p>Save the following YAML (below) to filename <code>mirror-peer.yaml</code> after replacing <strong>&lt;cluster1&gt;</strong> and <strong>&lt;cluster2&gt;</strong> with the correct names of your managed clusters in <strong>ACM</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no need to specify a namespace to create this resource because <code>MirrorPeer</code> is a cluster-scoped resource.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: multicluster.odf.openshift.io/v1alpha1
kind: MirrorPeer
metadata:
  name: mirrorpeer-&lt;cluster1&gt;-&lt;cluster2&gt;
spec:
  items:
  - clusterName: &lt;cluster1&gt;
    storageClusterRef:
      name: ocs-storagecluster
      namespace: openshift-storage
  - clusterName: &lt;cluster2&gt;
    storageClusterRef:
      name: ocs-storagecluster
      namespace: openshift-storage
  manageS3: true
  mirroringMode: snapshot
  replicationSecretName: rook-csi-rbd-provisioner
  schedulingIntervals:
  - 5m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the <code>Mirror Peer</code> resource by copying the contents of your unique <code>mirror-peer.yaml</code> file into the <code>YAML view</code> (completely replacing original content). Select <strong>Create</strong> at the bottom of the <code>YAML view</code> screen.</p>
</div>
<div class="paragraph">
<p>You can also create this resource using CLI.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f mirror-peer.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mirrorpeer.multicluster.odf.openshift.io/mirrorpeer-ocp4perf1-ocp4perf2 created</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can validate the secret (created from token) has been exchanged with this validation command.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Before executing the command replace <strong>&lt;cluster1&gt;</strong> and <strong>&lt;cluster2&gt;</strong> with your correct values.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get mirrorpeer mirrorpeer-&lt;cluster1&gt;-&lt;cluster2&gt; -o jsonpath='{.status.phase}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">ExchangedSecret</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validate_mirroring_on_managed_clusters"><a class="anchor" href="#_validate_mirroring_on_managed_clusters"></a>5.3. Validate Mirroring on Managed clusters</h3>
<div class="paragraph">
<p>Validate mirroring is enabled on default <strong>CephBlockPool</strong> on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get cephblockpool -n openshift-storage -o=jsonpath='{.items[?(@.metadata.ownerReferences[*].kind=="StorageCluster")].spec.mirroring.enabled}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Validate <code>rbd-mirror</code> <strong>Pod</strong> is up and running on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods -o name -l app=rook-ceph-rbd-mirror -n openshift-storage</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">pod/rook-ceph-rbd-mirror-a-6486c7d875-56v2v</code></pre>
</div>
</div>
<div class="paragraph">
<p>Validate the status of the <code>daemon</code> health on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get cephblockpool ocs-storagecluster-cephblockpool -n openshift-storage -o jsonpath='{.status.mirroringStatus.summary}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{"daemon_health":"OK","health":"OK","image_health":"OK","states":{}}</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
It could take up to 10 minutes for the <code>daemon_health</code> and <code>health</code> to go from <strong>Warning</strong> to <strong>OK</strong>. If the status does not become <strong>OK</strong> eventually then use the ACM console to verify that the <code>Submariner add-ons</code> connection is still in a healthy state.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Validate that the <strong>VolumeReplicationClass</strong> is created on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get volumereplicationclass</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                             PROVISIONER
odf-rbd-volumereplicationclass   openshift-storage.rbd.csi.ceph.com</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <strong>VolumeReplicationClass</strong> is used to specify the <code>mirroringMode</code> for each volume to be replicated as well as how often a volume or image is replicated (for example, every 5 minutes) from the local cluster to the remote cluster.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_validate_object_buckets_and_s3storeprofiles"><a class="anchor" href="#_validate_object_buckets_and_s3storeprofiles"></a>5.4. Validate Object Buckets and s3StoreProfiles</h3>
<div class="paragraph">
<p>Validate there is a new <strong>OBC</strong> and corresponding <strong>OB</strong> in the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong> in the <code>openshift-storage</code> namespace.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The new object buckets are created in the <code>openshift-storage</code> namespace on the managed clusters.
</td>
</tr>
</table>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get obc,ob -n openshift-storage</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                             PROVISIONER
NAME                                                       STORAGE-CLASS                 PHASE   AGE
objectbucketclaim.objectbucket.io/odrbucket-21eb5332f6b6   openshift-storage.noobaa.io   Bound   13m

NAME                                                                        STORAGE-CLASS                 CLAIM-NAMESPACE   CLAIM-NAME   RECLAIM-POLICY   PHASE   AGE
objectbucket.objectbucket.io/obc-openshift-storage-odrbucket-21eb5332f6b6   openshift-storage.noobaa.io                                  Delete           Bound   13m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Validate there are two new <strong>Secrets</strong> in the <strong>Hub cluster</strong> <code>openshift-dr-system</code> namespace that contain the access and secret key for each new <strong>OBC</strong>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The new secrets are created in the <code>openshift-dr-system</code> namespace on the <strong>Hub cluster</strong>. Later, these secrets will be copied to the managed clusters to access the object buckets.
</td>
</tr>
</table>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get secrets -n openshift-dr-system | grep Opaque</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">8b3fb9ed90f66808d988c7edfa76eba35647092   Opaque                                2      16m
af5f82f21f8f77faf3de2553e223b535002e480   Opaque                                2      16m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <strong>OBC</strong> and <strong>Secrets</strong> are written in the <strong>ConfigMap</strong> <code>ramen-hub-operator-config</code> on the <strong>Hub cluster</strong> in the newly created <code>s3StoreProfiles</code> section.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get cm ramen-hub-operator-config -n openshift-dr-system -o yaml | grep -A 14 s3StoreProfiles</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">    s3StoreProfiles:
    - s3Bucket: odrbucket-21eb5332f6b6
      s3CompatibleEndpoint: https://s3-openshift-storage.apps.perf2.example.com
      s3ProfileName: s3profile-ocp4perf2-ocs-storagecluster
      s3Region: noobaa
      s3SecretRef:
        name: 8b3fb9ed90f66808d988c7edfa76eba35647092
        namespace: openshift-dr-system
    - s3Bucket: odrbucket-21eb5332f6b6
      s3CompatibleEndpoint: https://s3-openshift-storage.apps.perf1.example.com
      s3ProfileName: s3profile-ocp4perf1-ocs-storagecluster
      s3Region: noobaa
      s3SecretRef:
        name: af5f82f21f8f77faf3de2553e223b535002e480
        namespace: openshift-dr-system</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Record the names of the <code>s3ProfileName</code>. They will be used in the <strong>DRPolicy</strong> resource.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_mirroring_storageclass_resource"><a class="anchor" href="#_create_mirroring_storageclass_resource"></a>6. Create Mirroring StorageClass resource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The block volumes with <code>mirroring enabled</code> must be created using a new <strong>StorageClass</strong> that has additional <code>imageFeatures</code> required to enable faster image replication between managed clusters. The new features are <em>exclusive-lock</em>, <em>object-map</em>, and <em>fast-diff</em>. The default ODF <strong>StorageClass</strong> <code>ocs-storagecluster-ceph-rbd</code> does not include these features.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This resource must be created on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save this YAML to filename <code>ocs-storagecluster-ceph-rbdmirror.yaml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">allowVolumeExpansion: true
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ocs-storagecluster-ceph-rbdmirror
parameters:
  clusterID: openshift-storage
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: openshift-storage
  csi.storage.k8s.io/fstype: ext4
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: openshift-storage
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: openshift-storage
  imageFeatures: layering,exclusive-lock,object-map,fast-diff
  imageFormat: "2"
  pool: ocs-storagecluster-cephblockpool
provisioner: openshift-storage.rbd.csi.ceph.com
reclaimPolicy: Delete
volumeBindingMode: Immediate</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f ocs-storagecluster-ceph-rbdmirror.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">storageclass.storage.k8s.io/ocs-storagecluster-ceph-rbdmirror created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_ssl_access_between_s3_endpoints"><a class="anchor" href="#_configure_ssl_access_between_s3_endpoints"></a>7. Configure SSL access between S3 endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These steps are necessary so that metadata can be stored on the alternate cluster in a Multi-Cloud Gateway (MCG) object bucket using a secure transport protocol and in addition the <strong>Hub cluster</strong> needs to verify access to the object buckets.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If all of your OpenShift clusters are deployed using signed and valid set of certificates for your environment then this section can be skipped.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Extract the ingress certificate for the <strong>Primary managed cluster</strong> and save the output to <code>primary.crt</code>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get cm default-ingress-cert -n openshift-config-managed -o jsonpath="{['data']['ca-bundle\.crt']}" &gt; primary.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Extract the ingress certificate for the <strong>Secondary managed cluster</strong> and save the output to <code>secondary.crt</code>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get cm default-ingress-cert -n openshift-config-managed -o jsonpath="{['data']['ca-bundle\.crt']}" &gt; secondary.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new YAML file <code>cm-clusters-crt.yaml</code> to hold the certificate bundle for both the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There could be more or less than three certificates for each cluster as shown in this example file.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
data:
  ca-bundle.crt: |
    -----BEGIN CERTIFICATE-----
    &lt;copy contents of cert1 from primary.crt here&gt;
    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----
    &lt;copy contents of cert2 from primary.crt here&gt;
    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----
    &lt;copy contents of cert3 primary.crt here&gt;
    -----END CERTIFICATE----

    -----BEGIN CERTIFICATE-----
    &lt;copy contents of cert1 from secondary.crt here&gt;
    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----
    &lt;copy contents of cert2 from secondary.crt here&gt;
    -----END CERTIFICATE-----

    -----BEGIN CERTIFICATE-----
    &lt;copy contents of cert3 from secondary.crt here&gt;
    -----END CERTIFICATE-----
kind: ConfigMap
metadata:
  name: user-ca-bundle
  namespace: openshift-config</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <strong>ConfigMap</strong> needs to be created on the <strong>Primary managed cluster</strong>, <strong>Secondary managed cluster</strong>, <em>and</em> the <strong>Hub cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f cm-clusters-crt.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">configmap/user-ca-bundle created</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <strong>Hub cluster</strong> needs to verify access to the object buckets using the <strong>DRPolicy</strong> resource. Therefore the same <strong>ConfigMap</strong>, <code>cm-clusters-crt.yaml</code>, needs to be created on the <strong>Hub cluster</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After all the <code>user-ca-bundle</code> <strong>ConfigMaps</strong> are created, the default <strong>Proxy</strong> <code>cluster</code> resource needs to be modified.</p>
</div>
<div class="paragraph">
<p>Patch the default <strong>Proxy</strong> resource on the <strong>Primary managed cluster</strong>, <strong>Secondary managed cluster</strong>, and the <strong>Hub cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc patch proxy cluster --type=merge  --patch='{"spec":{"trustedCA":{"name":"user-ca-bundle"}}}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">proxy.config.openshift.io/cluster patched</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_drpolicy_on_hub_cluster"><a class="anchor" href="#_create_drpolicy_on_hub_cluster"></a>8. Create DRPolicy on Hub cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ODR uses the <strong>DRPolicy</strong> resources on the ACM hub cluster to deploy, failover, and relocate, workloads across managed clusters. A <strong>DRPolicy</strong> requires a set of two clusters, which are peered for storage level replication and <code>CSI</code> <strong>VolumeReplication</strong> is enabled.</p>
</div>
<div class="paragraph">
<p>Furthermore, <strong>DRPolicy</strong> requires a scheduling interval that determines at what frequency data replication will be performed and also serves as a coarse grained RPO (Recovery Point Objective) for the workload using the <strong>DRPolicy</strong>.</p>
</div>
<div class="paragraph">
<p><strong>DRPolicy</strong> also requires that each cluster in the policy be assigned a S3 profile name, which is configured via the <strong>ConfigMap</strong> <code>ramen-hub-operator-config</code> in the <code>openshift-dr-system</code> on the <strong>Hub cluster</strong>.</p>
</div>
<div class="paragraph">
<p>On the <strong>Hub cluster</strong> navigate to <code>Installed Operators</code> in the <code>openshift-dr-system</code> project and select <code>ODR Hub Operator</code>. You should see two available APIs, <strong>DRPolicy</strong> and <strong>DRPlacementControl</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPolicy-API.png" alt="ODR Hub cluster APIs">
</div>
<div class="title">Figure 12. ODR Hub cluster APIs</div>
</div>
<div class="paragraph">
<p><strong>Create instance</strong> for <strong>DRPolicy</strong> and then go to <strong>YAML view</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPolicy-create-instance.png" alt="DRPolicy create instance">
</div>
<div class="title">Figure 13. DRPolicy create instance</div>
</div>
<div class="paragraph">
<p>Save the following YAML to filename drpolicy.yaml after replacing <strong>&lt;cluster1&gt;</strong> and <strong>&lt;cluster2&gt;</strong> with the correct names of your managed clusters in <strong>ACM</strong>. Replace <strong>&lt;string_value_1&gt;</strong> and <strong>&lt;string_value_2&gt;</strong> with any values as long as they unique (i.e., east and west).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no need to specify a namespace to create this resource because <code>DRPolicy</code> is a cluster-scoped resource.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: ramendr.openshift.io/v1alpha1
kind: DRPolicy
metadata:
  name: odr-policy-5m
spec:
  drClusterSet:
  - name: &lt;cluster1&gt;
    region: &lt;string_value_1&gt;
    s3ProfileName: s3profile-&lt;cluster1&gt;-ocs-storagecluster
  - name: &lt;cluster2&gt;
    region: &lt;string_value_2&gt;
    s3ProfileName: s3profile-&lt;cluster2&gt;-ocs-storagecluster
  schedulingInterval: 5m</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <strong>DRPolicy</strong> scheduling interval <strong><em>must</em></strong> match that configured in the default <strong>VolumeReplicationClass</strong> resource which is configured as <code>5m</code>. To have a different <code>schedulingInterval</code> for volume replication requires creating additional <strong>VolumeReplicationClass</strong> and <strong>DRPolicy</strong> with the same value (i.e., 15m).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now create the <code>DRPolicy</code> resource by copying the contents of your unique <code>drpolicy.yaml</code> file into the <code>YAML view</code> (completely replacing original content). Select <strong>Create</strong> at the bottom of the <code>YAML view</code> screen.</p>
</div>
<div class="paragraph">
<p>You can also create this resource using CLI</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f drpolicy.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">drpolicy.ramendr.openshift.io/odr-policy-5m created</code></pre>
</div>
</div>
<div class="paragraph">
<p>To validate that the <strong>DRPolicy</strong> is created successfully run this command on the <strong>Hub cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get drpolicy odr-policy-5m -n openshift-dr-system -o jsonpath='{.status.conditions[].reason}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Succeeded</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enable_automatic_install_of_odr_cluster_operator"><a class="anchor" href="#_enable_automatic_install_of_odr_cluster_operator"></a>9. Enable Automatic Install of ODR Cluster operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the <strong>DRPolicy</strong> is created successfully the <code>ODR Cluster operator</code> can be installed on the <strong>Primary managed cluster</strong> and <strong>Secondary managed cluster</strong> in the <code>openshift-dr-system</code> namespace.</p>
</div>
<div class="paragraph">
<p>This is done by editing the <code>ramen-hub-operator-config</code> <strong>ConfigMap</strong> on the <strong>Hub cluster</strong> and adding <code>deploymentAutomationEnabled=true</code>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc edit configmap ramen-hub-operator-config -n openshift-dr-system</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
data:
  ramen_manager_config.yaml: |
    apiVersion: ramendr.openshift.io/v1alpha1
    drClusterOperator:
      deploymentAutomationEnabled: true  ## &lt;-- Add to enable installation of ODR Cluster operator on managed clusters
      catalogSourceName: redhat-operators
      catalogSourceNamespaceName: openshift-marketplace
      channelName: stable-4.10
      clusterServiceVersionName: odr-cluster-operator.v4.10.0
      namespaceName: openshift-dr-system
      packageName: odr-cluster-operator
[...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>To validate that the installation was successful on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong> do the following command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get csv,pod -n openshift-dr-system</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                                                      DISPLAY                         VERSION   REPLACES   PHASE
clusterserviceversion.operators.coreos.com/odr-cluster-operator.v4.10.0   Openshift DR Cluster Operator   4.10.0               Succeeded

NAME                                             READY   STATUS    RESTARTS   AGE
pod/ramen-dr-cluster-operator-5564f9d669-f6lbc   2/2     Running   0          5m32s</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also go to <strong>OperatorHub</strong> on each of the managed clusters and look to see the <code>OpenShift DR Cluster Operator</code> is installed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-Cluster-operator.png" alt="ODR Cluster Operator">
</div>
<div class="title">Figure 14. ODR Cluster Operator</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_s3_secrets_on_managed_clusters"><a class="anchor" href="#_create_s3_secrets_on_managed_clusters"></a>10. Create S3 Secrets on Managed clusters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The MCG object bucket <strong>Secrets</strong> were created and stored on the <strong>Hub cluster</strong> when the <strong>MirrorPeer</strong> was created.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get secrets -n openshift-dr-system | grep Opaque</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">8b3fb9ed90f66808d988c7edfa76eba35647092   Opaque                                2      10h
af5f82f21f8f77faf3de2553e223b535002e480   Opaque                                2      10h</code></pre>
</div>
</div>
<div class="paragraph">
<p>These <strong>Secrets</strong> need to be copied to the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>. An easy way to do this is to export each <strong>Secret</strong> to a YAML file on the <strong>Hub cluster</strong>. Here is an example using the <strong>Secret</strong> names in the <code>Example output</code> above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get secrets 8b3fb9ed90f66808d988c7edfa76eba35647092 -n openshift-dr-system -o yaml &gt; odr-s3-secret1.yaml</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat odr-s3-secret1.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
data:
  AWS_ACCESS_KEY_ID: OXNsSk9aT3VVa3JEV0hRaXhwMmw=
  AWS_SECRET_ACCESS_KEY: a2JPUE9XS25RekwzMWlyR1BhbDhtNlUraWx2NWJicGwrenhKNHlqdA==
kind: Secret
metadata:
  creationTimestamp: "2022-02-26T01:26:40Z"
  labels:
    multicluster.odf.openshift.io/created-by: mirrorpeersecret
  name: 8b3fb9ed90f66808d988c7edfa76eba35647092
  namespace: openshift-dr-system
  resourceVersion: "810592"
  uid: cde532dc-2a87-47e5-97cd-8420b3c344de
type: Opaque</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then export the YAML for the other <strong>Secret</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get secrets af5f82f21f8f77faf3de2553e223b535002e480 -n openshift-dr-system -o yaml &gt; odr-s3-secret2.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Make sure to use <em>your</em> unique <strong>Secret</strong> names in the commands above.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now create both these <strong>Secrets</strong> on the <strong>Primary managed cluster</strong> <em>and</em> the <strong>Secondary managed cluster</strong>. They are created in the <code>openshift-dr-system</code> namespace.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f odr-s3-secret1.yaml -n openshift-dr-system</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">secret/8b3fb9ed90f66808d988c7edfa76eba35647092 created</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f odr-s3-secret2.yaml -n openshift-dr-system</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">secret/af5f82f21f8f77faf3de2553e223b535002e480 created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_sample_application_for_dr_testing"><a class="anchor" href="#_create_sample_application_for_dr_testing"></a>11. Create Sample Application for DR testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to test failover from the <strong>Primary managed cluster</strong> to the <strong>Secondary managed cluster</strong> and back again we need a simple application. The sample application used for this example with be <code>busybox</code>.</p>
</div>
<div class="paragraph">
<p>The first step is to create a namespace or project on the <strong>Hub cluster</strong> for <code>busybox</code> sample application.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc new-project busybox-sample</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A different project name other than <code>busybox-sample</code> can be used if desired. Make sure when deploying the sample application via the ACM console to use the same project name as what is created in this step.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_create_drplacementcontrol_resource"><a class="anchor" href="#_create_drplacementcontrol_resource"></a>11.1. Create DRPlacementControl resource</h3>
<div class="paragraph">
<p><strong>DRPlacementControl</strong> is an API available after the <code>ODR Hub Operator</code> is installed on the <strong>Hub cluster</strong>. It is broadly an ACM PlacementRule reconciler that orchestrates placement decisions based on data availability across clusters that are part of a <strong>DRPolicy</strong>.</p>
</div>
<div class="paragraph">
<p>On the <strong>Hub cluster</strong> navigate to <code>Installed Operators</code> in the <code>busybox-sample</code> project and select <code>ODR Hub Operator</code>. You should see two available APIs, <strong>DRPolicy</strong> and <strong>DRPlacementControl</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPolicy-API.png" alt="ODR Hub cluster APIs">
</div>
<div class="title">Figure 15. ODR Hub cluster APIs</div>
</div>
<div class="paragraph">
<p><strong>Create instance</strong> for <strong>DRPlacementControl</strong> and then go to <strong>YAML view</strong>. Make sure the <code>busybox-sample</code> namespace is selected at the top.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPlacementControl-create-instance.png" alt="DRPlacementControl create instance">
</div>
<div class="title">Figure 16. DRPlacementControl create instance</div>
</div>
<div class="paragraph">
<p>Save the following YAML (below) to filename busybox-drpc.yaml after replacing <strong>&lt;cluster1&gt;</strong> with the correct name of your managed cluster in <strong>ACM</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: ramendr.openshift.io/v1alpha1
kind: DRPlacementControl
metadata:
  labels:
    app: busybox-sample
  name: busybox-drpc
spec:
  drPolicyRef:
    name: odr-policy-5m
  placementRef:
    kind: PlacementRule
    name: busybox-placement
  preferredCluster: &lt;cluster1&gt;
  pvcSelector:
    matchLabels:
      appname: busybox</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the <strong>DRPlacementControl</strong> resource by copying the contents of your unique <code>busybox-drpc.yaml</code> file into the <code>YAML view</code> (completely replacing original content). Select <strong>Create</strong> at the bottom of the <code>YAML view</code> screen.</p>
</div>
<div class="paragraph">
<p>You can also create this resource using CLI.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This resource must be created in the <code>busybox-sample</code> namespace (or whatever namespace you created earlier).
</td>
</tr>
</table>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f busybox-drpc.yaml -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">drplacementcontrol.ramendr.openshift.io/busybox-drpc created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_placementrule_resource"><a class="anchor" href="#_create_placementrule_resource"></a>11.2. Create PlacementRule resource</h3>
<div class="paragraph">
<p>Placement rules define the target clusters where resource templates can be deployed. Use placement rules to help you facilitate the multicluster deployment of your applications.</p>
</div>
<div class="paragraph">
<p>Save the following YAML (below) to filename busybox-placementrule.yaml.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  labels:
    app: busybox-sample
  name: busybox-placement
spec:
  clusterConditions:
  - status: "True"
    type: ManagedClusterConditionAvailable
  clusterReplicas: 1
  schedulerName: ramen</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now create the <strong>PlacementRule</strong> resource for the <code>busybox-sample</code> application.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This resource must be created in the <code>busybox-sample</code> namespace (or whatever namespace you created earlier).
</td>
</tr>
</table>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc create -f busybox-placementrule.yaml -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">placementrule.apps.open-cluster-management.io/busybox-placement created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_sample_application_using_acm_console"><a class="anchor" href="#_creating_sample_application_using_acm_console"></a>11.3. Creating Sample Application using ACM console</h3>
<div class="paragraph">
<p>Start by loggin into the ACM console using your OpenShift credentials if not already logged in.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get route multicloud-console -n open-cluster-management -o jsonpath --template="https://{.spec.host}/multicloud/applications{'\n'}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will return a route similar to this one.</p>
</div>
<div class="listingblock">
<div class="title">Example Output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">https://multicloud-console.apps.perf3.example.com/multicloud/applications</code></pre>
</div>
</div>
<div class="paragraph">
<p>After logging in select <strong>Create application</strong> in the top right and choose <strong>Subscription</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-Create-application.png" alt="ACM Create application">
</div>
<div class="title">Figure 17. ACM Create application</div>
</div>
<div class="paragraph">
<p>Fill out the top of the <code>Create an application</code> form as shown below and select repository type <strong>Git</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-application-form1.png" alt="ACM Application name and namespace">
</div>
<div class="title">Figure 18. ACM Application name and namespace</div>
</div>
<div class="paragraph">
<p>The next section to fill out is below the <strong>Git</strong> box and is the repository URL for the sample application, the <strong>github</strong> branch and path to resources that will be created, the <code>busybox</code> <strong>Pod</strong> and <strong>PVC</strong>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure that the new <strong>StorageClass</strong> <code>ocs-storagecluster-ceph-rbdmirror</code> is created as detailed in section <a href="#_create_mirroring_storageclass_resource">Create Mirroring StorageClass resource</a> on the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong> before proceeding. Verify it is created using the following command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get storageclass | grep rbdmirror | awk {'print $1}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">ocs-storagecluster-ceph-rbdmirror</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>Sample application repository</strong> <a href="https://github.com/RamenDR/ocm-ramen-samples" class="bare">github.com/RamenDR/ocm-ramen-samples</a>. Branch is <code>main</code> and path is <code>busybox-odr</code>.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-application-form2a.png" alt="ACM application repository information">
</div>
<div class="title">Figure 19. ACM application repository information</div>
</div>
<div class="paragraph">
<p>Scroll down in the form until you see <strong>Select an existing placement configuration</strong> and then put your cursor in the box below. You should see the <strong>PlacementRule</strong> created in prior section. Select this rule.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-application-form3.png" alt="ACM application placement rule">
</div>
<div class="title">Figure 20. ACM application placement rule</div>
</div>
<div class="paragraph">
<p>After selecting available rule then select <strong>Save</strong> in the upper right hand corner.</p>
</div>
<div class="paragraph">
<p>On the follow-on screen scroll to the bottom. You should see that there are all <strong>Green</strong> checkmarks on the application topology.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-application-successfull.png" alt="ACM application successful topology view">
</div>
<div class="title">Figure 21. ACM application successful topology view</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To get more information click on any of the topology elements and a window will appear to right of the topology view.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_validating_sample_application_deployment_and_replication"><a class="anchor" href="#_validating_sample_application_deployment_and_replication"></a>11.4. Validating Sample Application deployment and replication</h3>
<div class="paragraph">
<p>Now that the <code>busybox</code> application has been deployed to your <strong>preferredCluster</strong> (specified in the <code>DRPlacementControl</code>) the deployment can be validated.</p>
</div>
<div class="paragraph">
<p>Logon to your managed cluster where <code>busybox</code> was deployed by ACM. This is most likely your <strong>Primary managed cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods,pvc -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME          READY   STATUS    RESTARTS   AGE
pod/busybox   1/1     Running   0          6m

NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                  AGE
persistentvolumeclaim/busybox-pvc   Bound    pvc-a56c138a-a1a9-4465-927f-af02afbbff37   1Gi        RWO            ocs-storagecluster-ceph-rbd   6m</code></pre>
</div>
</div>
<div class="paragraph">
<p>To validate that the replication resources are also created for the <code>busybox</code> <strong>PVC</strong> do the following:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get volumereplication,volumereplicationgroup -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                                             AGE   VOLUMEREPLICATIONCLASS           PVCNAME       DESIREDSTATE   CURRENTSTATE
volumereplication.replication.storage.openshift.io/busybox-pvc   6m   odf-rbd-volumereplicationclass   busybox-pvc   primary        Primary

NAME                                                       AGE
volumereplicationgroup.ramendr.openshift.io/busybox-drpc   6m</code></pre>
</div>
</div>
<div class="paragraph">
<p>To validate that the <code>busybox</code> volume has been replicated to the alternate cluster run this command on both the <strong>Primary managed cluster</strong> and the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get cephblockpool ocs-storagecluster-cephblockpool -n openshift-storage -o jsonpath='{.status.mirroringStatus.summary}{"\n"}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">{"daemon_health":"OK","health":"OK","image_health":"OK","states":{"replaying":2}}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both managed clusters should have the exact same output with a new status of <strong>"states":{"replaying":2}</strong>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deleting_the_sample_application"><a class="anchor" href="#_deleting_the_sample_application"></a>11.5. Deleting the Sample Application</h3>
<div class="paragraph">
<p>Deleting the <code>busybox</code> application can be done using the ACM console. Navigate to <strong>Applications</strong> and then find the application to be deleted (busybox in this case).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-application-delete.png" alt="ACM delete busybox application">
</div>
<div class="title">Figure 22. ACM delete busybox application</div>
</div>
<div class="paragraph">
<p>When <strong>Delete application</strong> is selected a new screen will appear asking if the <code>application related resources</code> should also be deleted. Make sure to <code>check</code> the box to delete the <code>Subscription</code> and <code>PlacementRule</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ACM-application-delete-resources.png" alt="ACM delete busybox application resources">
</div>
<div class="title">Figure 23. ACM delete busybox application resources</div>
</div>
<div class="paragraph">
<p>Select <strong>Delete</strong> in this screen. This will delete the <code>busybox</code> application on the <strong>Primary managed cluster</strong> (or whatever cluster the application was running on).</p>
</div>
<div class="paragraph">
<p>In addition to the resources deleted using the ACM console, the <code>DRPlacementControl</code> must also be deleted immediately after deleting the <code>busybox</code> application. Logon to the OpenShift Web console for the <strong>Hub cluster</strong>. Navigate to <code>Installed Operators</code> for the project <code>busybox-sample</code>. Choose <code>OpenShift DR Hub Operator</code> and the <strong>DRPlacementControl</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPlacementControl-delete.png" alt="Delete busybox application DRPlacementControl">
</div>
<div class="title">Figure 24. Delete busybox application DRPlacementControl</div>
</div>
<div class="paragraph">
<p>Select <strong>Delete DRPlacementControl</strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If desired, the <code>DRPlacementControl</code> resource can also be deleted in the application namespace using CLI.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This process can be used to delete any application with a DRPlacementControl resource.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_failover_between_managed_clusters"><a class="anchor" href="#_application_failover_between_managed_clusters"></a>12. Application Failover between managed clusters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section will detail how to failover the <code>busybox</code> sample application. The failover method for <code>Regional Disaster Recovery</code> is application based. Each application that is to be protected in this manner must have a corresponding <strong>DRPlacementControl</strong> resource and a <strong>PlacementRule</strong> resource created in the application namespace as shown in the <a href="#_create_sample_application_for_dr_testing">Create Sample Application for DR testing</a> section.</p>
</div>
<div class="paragraph">
<p>To failover requires modifying the <strong>DRPlacementControl</strong> YAML view. On the <strong>Hub cluster</strong> navigate to <code>Installed Operators</code> and then to <code>Openshift DR Hub Operator</code>. Select <strong>DRPlacementControl</strong> as show below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPlacementControl-instance.png" alt="DRPlacementControl busybox instance">
</div>
<div class="title">Figure 25. DRPlacementControl busybox instance</div>
</div>
<div class="paragraph">
<p>Select <code>drpc-busybox</code> and then the YAML view. Add the <code>action</code> and <code>failoverCluster</code> as shown below. The <code>failoverCluster</code> should be the <strong>ACM</strong> cluster name for the <strong>Secondary managed cluster</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPlacementControl-failover.png" alt="DRPlacementControl add action Failover">
</div>
<div class="title">Figure 26. DRPlacementControl add action Failover</div>
</div>
<div class="paragraph">
<p>Select <strong>Save</strong>.</p>
</div>
<div class="paragraph">
<p>In the <code>failoverCluster</code> specified in the YAML file (i.e., ocp4perf2), see if the application <code>busybox</code> is now running in the <strong>Secondary managed cluster</strong> using the following command:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods,pvc -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME          READY   STATUS    RESTARTS   AGE
pod/busybox   1/1     Running   0          35s

NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                  AGE
persistentvolumeclaim/busybox-pvc   Bound    pvc-79f2a74d-6e2c-48fb-9ed9-666b74cfa1bb   5Gi        RWO            ocs-storagecluster-ceph-rbd   35s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, using the same command check if <code>busybox</code> is running in the <strong>Primary managed cluster</strong>. The <code>busybox</code> application should no longer be running on this managed cluster.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods,pvc -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">No resources found in busybox-sample namespace.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_failback_between_managed_clusters"><a class="anchor" href="#_application_failback_between_managed_clusters"></a>13. Application Failback between managed clusters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A failback operation is very similar to failover. The failback is application based and uses the <strong>DRPlacementControl</strong> to trigger the failback. The main difference for failback is that a <code>resync</code> is issued to make sure any new application data saved on the <strong>Secondary managed cluster</strong> is immediately, not waiting for the mirroring schedule interval, replicated to the <strong>Primary managed cluster</strong>.</p>
</div>
<div class="paragraph">
<p>To failback requires modifying the <strong>DRPlacementControl</strong> YAML view. On the <strong>Hub cluster</strong> navigate to <code>Installed Operators</code> and then to <code>Openshift DR Hub Operator</code>. Select <strong>DRPlacementControl</strong> as show below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPlacementControl-instance.png" alt="DRPlacementControl busybox instance">
</div>
<div class="title">Figure 27. DRPlacementControl busybox instance</div>
</div>
<div class="paragraph">
<p>Select <code>drpc-busybox</code> and then the YAML form. Modify the <code>action</code> to <code>Relocate</code> as shown below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ODR-DRPlacementControl-failback.png" alt="DRPlacementControl modify action to Relocate">
</div>
<div class="title">Figure 28. DRPlacementControl modify action to Relocate</div>
</div>
<div class="paragraph">
<p>Select <strong>Save</strong>.</p>
</div>
<div class="paragraph">
<p>Check if the application <code>busybox</code> is now running in the <strong>Primary managed cluster</strong> using the following command. The failback is to the <code>preferredCluster</code> which should be where the application was running before the failover operation.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods,pvc -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME          READY   STATUS    RESTARTS   AGE
pod/busybox   1/1     Running   0          60s

NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS                  AGE
persistentvolumeclaim/busybox-pvc   Bound    pvc-79f2a74d-6e2c-48fb-9ed9-666b74cfa1bb   5Gi        RWO            ocs-storagecluster-ceph-rbd   61s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, using the same command, check if <code>busybox</code> is running in the <strong>Secondary managed cluster</strong>. The <code>busybox</code> application should no longer be running on this managed cluster.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pods,pvc -n busybox-sample</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">No resources found in busybox-sample namespace.</code></pre>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Red Hat Data Services">
  </a>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
