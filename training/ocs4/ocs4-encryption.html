<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>At-rest and PersistentVolume encryption with an external KMS :: OCS Training</title>
    <link rel="canonical" href="https://red-hat-storage.github.io/ocs-training/training/ocs4/ocs4-encryption.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LGCEEZGN54"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-LGCEEZGN54')</script>
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
          <img src="../../_/img/header_logo_reverse.svg" height="40px" alt="Red Hat Data Services">
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Get Help</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://access.redhat.com/documentation/en-us/red_hat_openshift_container_storage" target="_blank">OCS Documentation</a>
            <a class="navbar-item" href="https://bugzilla.redhat.com/describecomponents.cgi?product=Red%20Hat%20OpenShift%20Container%20Storage" target="_blank">Browse Bugs</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Improve Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/blob/master/CONTRIBUTING.adoc" target="_blank">Guidelines</a>
            <a class="navbar-item" href="https://github.com/red-hat-storage/ocs-training/issues/new/choose" target="_blank">Open Issue</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Infos</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.redhat.com/en/blog/channel/red-hat-storage" target="_blank">Our Blog</a>
            <a class="navbar-item" href="https://www.youtube.com/channel/UCoyG8VyvB-XUxQl1mD3T3Gw" target="_blank">Youtube</a>
            <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">OCS Technology</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="training" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">OCS Installation and Configuration</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf.html">ODF General deploy and use</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-install-no-ui.html">OCS CLI based install</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-install-no-ui.html">ODF CLI based install</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="ocs4-encryption.html">External KMS Encryption</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-enable-rgw.html">Use RGW in OCS deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-cluster-storage-quotas.html">Cluster wide storage management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Disaster recovery</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-multisite-ramen.html">ODF 4.9 Regional disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf410-multisite-ramen.html">ODF 4.10 Regional disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-metro-stretched.html">Stretch Cluster disaster recovery</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="odf4-metro-ramen.html">ODF 4.10 Metro disaster recovery</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Development preview features</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-dbwal.html">BlueStore RocksDB metadata and WAL placement</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-devtype.html">Mixed OSD device type configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-override.html">Ceph configuration override</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="ocs4-additionalfeatures-segregation.html">Data Segregation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../infra-nodes/ocs4-infra-nodes.html">Deploying on Infra nodes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ocs4perf/ocs4perf.html">Test deployment post-install</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OCS Installation and Configuration</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">OCS Installation and Configuration</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../RegionalDR/index.html">ODF Regional DR</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../RegionalDR/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">OCS Installation and Configuration</a></li>
    <li><a href="ocs4-encryption.html">External KMS Encryption</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/red-hat-storage/ocs-training/edit/master/training/modules/ocs4/pages/ocs4-encryption.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">At-rest and <strong>PersistentVolume</strong> encryption with an external KMS</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_overview">1. Overview</a></li>
<li><a href="#_hashicorp_vault_deployment_configuration">2. <strong>HashiCorp Vault</strong> deployment &amp; configuration</a>
<ul class="sectlevel2">
<li><a href="#_installation">2.1. Installation</a></li>
<li><a href="#_starting_hashicorp_vault">2.2. Starting <strong>HashiCorp Vault</strong></a></li>
<li><a href="#_create_dedicated_kv_store">2.3. Create dedicated KV store</a></li>
</ul>
</li>
<li><a href="#_cluster_wide_at_rest_encryption">3. Cluster-wide at-rest encryption</a>
<ul class="sectlevel2">
<li><a href="#_deploy_odf_operator">3.1. Deploy ODF operator</a></li>
<li><a href="#_verify_encryption_keys">3.2. Verify encryption keys</a></li>
</ul>
</li>
<li><a href="#_granular_persistentvolume_at_rest_encryption">4. Granular <strong>PersistentVolume</strong> at-rest encryption</a>
<ul class="sectlevel2">
<li><a href="#_specific_storage_class">4.1. Specific storage class</a></li>
<li><a href="#_test_application">4.2. Test application</a></li>
</ul>
</li>
<li><a href="#_granular_persistentvolume_at_rest_encryption_without_cluster_wide_encryption_kubernetes_auth_method_serviceaccounts">5. Granular <strong>PersistentVolume</strong> at-rest encryption without cluster-wide encryption: Kubernetes Auth Method - ServiceAccounts</a>
<ul class="sectlevel2">
<li><a href="#_serviceaccounts_bindings_and_roles">5.1. ServiceAccounts, bindings and roles</a></li>
<li><a href="#_configureverify_vault_authentication">5.2. Configure/Verify Vault Authentication</a></li>
<li><a href="#_configureverify_vault_policies_for_odf">5.3. Configure/Verify Vault Policies for ODF</a></li>
<li><a href="#_create_an_encrypted_storageclass">5.4. Create an Encrypted StorageClass</a></li>
<li><a href="#_create_a_pvc_using_this_storageclass">5.5. Create a PVC using this StorageClass</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The intent of this guide is to detail the steps and commands necessary to
configure OpenShift Data Foundation (ODF) 4.9 to enable the use of an
<strong>HashiCorp Vault</strong> instance for storing the at-rest or <strong>PersistentVolume</strong> encryption keys.</p>
</div>
<div class="paragraph">
<p>The necessary components are one OCP 4.9 (or greater) clusters and the <code>OpenShift Data
Foundation</code> (ODF) operator installed with version <strong>4.9</strong> (or greater).</p>
</div>
<div class="paragraph">
<p>Encryption at rest can be used to provide protection against the following threats:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cluster wide encryption to protect the organization against device theft (all server or single device)</p>
</li>
<li>
<p>PV level encryption to guarantee isolation and confidentiality between tenants (applications).</p>
</li>
<li>
<p>Combined PV level encryption on top of cluster-wide encryption to offer both protections above at the same time</p>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Starting April 2021, <code>OpenShift Container Storage</code> (OCS) has been rebranded
to <code>OpenShift Data Foundation</code> (ODF).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The deployment will follow these high-level steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p><strong>Deploy HashiCorp Vault.</strong><br>
Deploy Hashicorp Vault inside of your cluster in a HA mode.</p>
</li>
<li>
<p><strong>Install ODF 4.9.</strong><br>
With cluster-wide and PV-level encryption</p>
</li>
<li>
<p><strong>Create your Storage Cluster.</strong><br>
Deploy your storage cluster pointing to HashiCorp Vault to provide cluster wide at-rest encryption.</p>
</li>
<li>
<p><strong>Deploy an application with PV encryption.</strong><br>
Deploy your application by pointing to HashiCorp Vault to provide <strong>PersistentVolume</strong> granular at-rest encryption.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hashicorp_vault_deployment_configuration"><a class="anchor" href="#_hashicorp_vault_deployment_configuration"></a>2. <strong>HashiCorp Vault</strong> deployment &amp; configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installation"><a class="anchor" href="#_installation"></a>2.1. Installation</h3>
<div class="paragraph">
<p>Hashicorp recommends using the Helm chart to install Vault in Openshift. Their documentation is available here: <a href="https://www.vaultproject.io/docs/platform/k8s/helm/openshift" class="bare">www.vaultproject.io/docs/platform/k8s/helm/openshift</a></p>
</div>
<div class="paragraph">
<p>These steps mainly consists of adding their helm repo and installing it on your cluster.</p>
</div>
<div class="paragraph">
<p>Make sure you are logged in to your target cluster, then create your target namespace to deploy vault:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc new-project vault</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Now using project "vault" on server "https://api.cluster0.aws.ocp.team:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app rails-postgresql-example

to build a new example application in Ruby. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=k8s.gcr.io/serve_hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the Hashicorp helm repo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm repo add hashicorp https://helm.releases.hashicorp.com</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">"hashicorp" has been added to your repositories</code></pre>
</div>
</div>
<div class="paragraph">
<p>And proceed to deploy a Production-ready HA Vault instance in your cluster</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm install vault hashicorp/vault \
                    --set='global.openshift=true' \
                    --set='server.ha.enabled=true' \
                    --set='server.ha.raft.enabled=true'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME: vault
LAST DEPLOYED: Thu Mar  3 09:39:37 2022
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://www.vaultproject.io/docs/


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you should see 4 Pods starting to appear in the vault namespace. Let&#8217;s initialize the Vault. This will give us the Root Token and the unseal keys.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Make sure to save the output of the following command. If you lose the keys, you will not be able to recover your data.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-0 -- vault operator init</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key 1: +nJfbHXXXXXXXXX
Unseal Key 2: l+DUOmXXXXXXXXX
Unseal Key 3: SnoGWZXXXXXXXXX
Unseal Key 4: wlDiQgXXXXXXXXX
Unseal Key 5: Get307XXXXXXXXX

Initial Root Token: s.t1yXXXXXXXXXXXXXX

Vault initialized with 5 key shares and a key threshold of 3. Please securely
distribute the key shares printed above. When the Vault is re-sealed,
restarted, or stopped, you must supply at least 3 of these keys to unseal it
before it can start servicing requests.

Vault does not store the generated master key. Without at least 3 keys to
reconstruct the master key, Vault will remain permanently sealed!

It is possible to generate new unseal keys, provided you have a quorum of
existing unseal keys shares. See "vault operator rekey" for more information.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to use Vault, we will need to init and unseal each of the three Vault servers. We will do so in the next chapter</p>
</div>
</div>
<div class="sect2">
<h3 id="_starting_hashicorp_vault"><a class="anchor" href="#_starting_hashicorp_vault"></a>2.2. Starting <strong>HashiCorp Vault</strong></h3>
<div class="paragraph">
<p>By now you should see 4 Pods. Three of those Pods are Running, but not ready</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 0/1     Running   0          36m
vault-1                                 0/1     Running   0          112m
vault-2                                 0/1     Running   0          39m
vault-agent-injector-5bd747fdd6-dp24b   1/1     Running   0          37m</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is because we have not unsealed them yet. You will have to do this every time the Vault Pod is restarted. This includes OpenShift upgrades. During a rolling reboot, you will have to unseal each Vault as the nodes come back up or the upgrade is interrupted by Vault&#8217;s poddisruptionbudget.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Every time a Vault server is restarted, you will need to unseal it
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-0 -- vault operator unseal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       5
Threshold          3
Unseal Progress    1/3
Unseal Nonce       cdfd99b7-5a21-4113-b0ef-c99b8417aac6
Version            1.9.2
Storage Type       raft
HA Enabled         true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Repeat the above until <code>Sealed</code> is marked as <code>false</code>!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-0 -- vault operator unseal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key (will be hidden):
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false
Total Shares            5
Threshold               3
Version                 1.9.2
Storage Type            raft
Cluster Name            vault-cluster-09d60b36
Cluster ID              145ec6b9-47ef-8aa7-aa3f-9a9d1ca40554
HA Enabled              true
HA Cluster              n/a
HA Mode                 standby
Active Node Address     &lt;none&gt;
Raft Committed Index    25
Raft Applied Index      25</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now proceed with the next Vault Pod and configure it to connect to the first Vault Pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-1 -- vault operator raft join http://vault-0.vault-internal:8200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Key       Value
---       -----
Joined    true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then proceed with unsealing this Pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-1 -- vault operator unseal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       5
Threshold          3
Unseal Progress    1/3
Unseal Nonce       cdfd99b7-5a21-4113-b0ef-c99b8417aac6
Version            1.9.2
Storage Type       raft
HA Enabled         true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Repeat the above until <code>Sealed</code> is marked as <code>false</code>!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-1 -- vault operator unseal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key (will be hidden):
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false
Total Shares            5
Threshold               3
Version                 1.9.2
Storage Type            raft
Cluster Name            vault-cluster-09d60b36
Cluster ID              145ec6b9-47ef-8aa7-aa3f-9a9d1ca40554
HA Enabled              true
HA Cluster              n/a
HA Mode                 standby
Active Node Address     &lt;none&gt;
Raft Committed Index    25
Raft Applied Index      25</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now proceed with the last Vault Pod and configure it to connect to the first Vault Pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-2 -- vault operator raft join http://vault-0.vault-internal:8200</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Key       Value
---       -----
Joined    true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then proceed with unsealing this Pod</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-2 -- vault operator unseal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       5
Threshold          3
Unseal Progress    1/3
Unseal Nonce       cdfd99b7-5a21-4113-b0ef-c99b8417aac6
Version            1.9.2
Storage Type       raft
HA Enabled         true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Repeat the above until <code>Sealed</code> is marked as <code>false</code>!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-2 -- vault operator unseal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Unseal Key (will be hidden):
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false
Total Shares            5
Threshold               3
Version                 1.9.2
Storage Type            raft
Cluster Name            vault-cluster-09d60b36
Cluster ID              145ec6b9-47ef-8aa7-aa3f-9a9d1ca40554
HA Enabled              true
HA Cluster              n/a
HA Mode                 standby
Active Node Address     &lt;none&gt;
Raft Committed Index    25
Raft Applied Index      25</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_dedicated_kv_store"><a class="anchor" href="#_create_dedicated_kv_store"></a>2.3. Create dedicated KV store</h3>
<div class="paragraph">
<p>Create a dedicated key-value store engine as a receptacle for the ODF keys
as they get generated during the deployment of an OSD. Together with the
key-value store, create a dedicated security policy and a specific security
token to be used by ODF to interact with the vault.</p>
</div>
<div class="paragraph">
<p>Execute the below commands inside of one of the Vault Pods</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-0 -n vault -- sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Login to the Vault instance. Use the Vault Root Token that you created with the unseal keys above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault login</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Token (will be hidden):
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.t1yyXXXXXXXX
token_accessor       qLxxdspcAYQoOnQsgquC6PY2
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the Key-Value store for OCS encryption keys</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault secrets enable -path=ocs kv-v2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Success! Enabled the kv-v2 secrets engine at: ocs/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a policy that enables ocs users to use that Key-Value store</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">echo '
  path "ocs/*" {
    capabilities = ["create", "read", "update", "delete", "list"]
  }
  path "sys/mounts" {
  capabilities = ["read"]
  }'| vault policy write ocs -</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Success! Uploaded policy: ocs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a token to access this Key-Value store</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault token create -policy=ocs -format json</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "request_id": "dac47681-922e-281a-22c4-7d3964830abc",
  "lease_id": "",
  "lease_duration": 0,
  "renewable": false,
  "data": null,
  "warnings": null,
  "auth": {
    "client_token": "s.KZxO1XXXXXXXXXXXXXX",
    "accessor": "ZyMMUquPez3Rps4whPLbvoNn",
    "policies": [
      "default",
      "ocs"
    ],
    "token_policies": [
      "default",
      "ocs"
    ],
    "identity_policies": null,
    "metadata": null,
    "orphan": false,
    "entity_id": "",
    "lease_duration": 2764800,
    "renewable": true
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At this point your Vault configuration is ready to be used by ODF
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cluster_wide_at_rest_encryption"><a class="anchor" href="#_cluster_wide_at_rest_encryption"></a>3. Cluster-wide at-rest encryption</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section you will be using an OCP cluster to deploy
ODF 4.9 using OperatorHub. The following will be installed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The ODF Operator</p>
</li>
<li>
<p>The ODF storage cluster (Ceph Pods, NooBaa Pods, StorageClasses)</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_deploy_odf_operator"><a class="anchor" href="#_deploy_odf_operator"></a>3.1. Deploy ODF operator</h3>
<div class="paragraph">
<p>Navigate to the <strong>Operators</strong> &#8594; <strong>OperatorHub</strong> menu.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS-OCP-OperatorHub.png" alt="OCP OperatorHub">
</div>
<div class="title">Figure 1. OCP OperatorHub</div>
</div>
<div class="paragraph">
<p>Now type <code>openshift container storage</code> in the <strong>Filter by <em>keyword&#8230;&#8203;</em></strong> box.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-OCP-OperatorHub-Filter.png" alt="OCP OperatorHub Filter">
</div>
<div class="title">Figure 2. OCP OperatorHub filter on OpenShift Container Storage Operator</div>
</div>
<div class="paragraph">
<p>Select <code>OpenShift Container Storage Operator</code> and then select <strong>Install</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-OCP4-OperatorHub-Install.png" alt="OCP OperatorHub Install">
</div>
<div class="title">Figure 3. OCP OperatorHub Install OpenShift Container Storage</div>
</div>
<div class="paragraph">
<p>On the next screen make sure the settings are as shown in this figure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-OCP4-OperatorHub-Subscribe.png" alt="OCP OperatorHub Subscribe">
</div>
<div class="title">Figure 4. OCP Subscribe to OpenShift Container Storage</div>
</div>
<div class="paragraph">
<p>Click <code>Install</code>.</p>
</div>
<div class="paragraph">
<p>Now you can go back to your terminal window to check the progress of the
installation.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">watch oc -n openshift-storage get csv</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                  DISPLAY                       VERSION   REPLACES              PHASE
odf-operator.v4.9.3   OpenShift Data Foundation     4.9.3     odf-operator.v4.9.2   Succeeded</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can exit by pressing <span class="keyseq"><kbd>Ctrl</kbd>+<kbd>C</kbd></span>.</p>
</div>
<div class="paragraph">
<p>The resource <code>csv</code> is a shortened word for
<code>clusterserviceversions.operators.coreos.com</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Please wait until the operator <code>PHASE</code> changes to <code>Succeeded</code></div>
This will mark that the installation of your operator was
successful. Reaching this state can take several minutes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will now also see new operator pods in <code>openshift-storage</code>
namespace:</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc -n openshift-storage get pods</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME                                   READY   STATUS    RESTARTS   AGE
noobaa-operator-698746cd47-sp6w9       1/1     Running   0          108s
ocs-metrics-exporter-78bc44687-pg4hk   1/1     Running   0          107s
ocs-operator-6d99bc6787-d7m9d          1/1     Running   0          108s
rook-ceph-operator-59f7fb95d6-sdjd8    1/1     Running   0          108s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now switch back to your <strong>Openshift Web Console</strong> for the remainder of the
installation for ODF 4.</p>
</div>
<div class="paragraph">
<p>Select <code>Create Storage Cluster</code> in figure below to get to the ODF configuration screen.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-OCP4-View-Operator.png" alt="Create storage cluster in openshift-storage namespace">
</div>
<div class="title">Figure 5. Create storage cluster in openshift-storage namespace</div>
</div>
<div class="paragraph">
<p>The <code>Create Storage Cluster</code> screen will display.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-config-screen-partial1.png" alt="Configure storage cluster settings">
</div>
<div class="title">Figure 6. Configure storage cluster settings</div>
</div>
<div class="paragraph">
<p>You can leave the default selection of <code>Internal</code>, <code>gp2</code>, <code>2 TiB</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-config-screen-partial2.png" alt="Select nodes for new storage cluster">
</div>
<div class="title">Figure 7. Select nodes for new storage cluster</div>
</div>
<div class="paragraph">
<p>Select all the nodes that should host ODF Pods and click on Next.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/KMS-Vault-Settings.jpg" alt="Configure Security for ODF">
</div>
<div class="title">Figure 8. Configure Security for ODF</div>
</div>
<div class="paragraph">
<p>In this screen, check the checkbox at 1.</p>
</div>
<div class="paragraph">
<p>Then provide a Service name at 2 for your KMS endpoint. This will be used later when creating a Storage Class for encrypting PVs. "vault" is a good default for this, since we are setting up a Vault KMS.</p>
</div>
<div class="paragraph">
<p>In 3 and 4 supply the address of the Vault cluster. Since we deploy within the cluster, we can use the Service address and the default Vaul Port <code>8200</code></p>
</div>
<div class="paragraph">
<p>In 5 supply the token that you got from the earlier command <code>vault token create -policy=ocs -format json</code></p>
</div>
<div class="paragraph">
<p>Then open up the advance settings by clicking on the blue text next to 6.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/KMS-Vault-Adv-Settings.jpg" alt="Configure Advanced Security for ODF">
</div>
<div class="title">Figure 9. Configure Advanced Security for ODF</div>
</div>
<div class="paragraph">
<p>Since we don&#8217;t use HTTPs for the Vault communication, all we have to do is set the Backend Path to <code>ocs</code>. All other fields can be left as-is.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-config-screen-partial3.png" alt="Review and create new storage cluster">
</div>
<div class="title">Figure 10. Review and create new storage cluster</div>
</div>
<div class="paragraph">
<p>Click <code>Create</code>.</p>
</div>
<div class="paragraph">
<p>You can watch the deployment using the <strong>Openshift Web Console</strong> by going
back to the <code>Openshift Container Storage Operator</code> screen and selecting <code>All
instances</code>.</p>
</div>
<div class="paragraph">
<p>Please wait until all <strong>Pods</strong> are marked as <code>Running</code> in the CLI or until you
see all instances shown below as <code>Ready</code> Status in the Web Console as shown in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-OCP4-finished-cluster-install.png" alt="OCS instance overview after cluster install is finished">
</div>
<div class="title">Figure 11. OCS instance overview after cluster install is finished</div>
</div>
</div>
<div class="sect2">
<h3 id="_verify_encryption_keys"><a class="anchor" href="#_verify_encryption_keys"></a>3.2. Verify encryption keys</h3>
<div class="paragraph">
<p>Open a remote shell on one of the Vault Pods</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-0 -n vault -- sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then login as the root, using the Token you got when initializing the Vault cluster</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault login</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Token (will be hidden):
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.t1yycIXXXXXXXX
token_accessor       qLxxdspcAYQoOnQsgquC6PY2
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>List all Keys in the <code>ocs</code> path.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault kv list ocs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Keys
---
NOOBAA_ROOT_SECRET_PATH/
rook-ceph-osd-encryption-key-ocs-deviceset-gp2-0-data-08p9p4
rook-ceph-osd-encryption-key-ocs-deviceset-gp2-1-data-0bd4n5
rook-ceph-osd-encryption-key-ocs-deviceset-gp2-2-data-0pzgmq</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If there are no items in <code>ocs</code> yet, make sure that the OSD Pods have been started already.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see some secret keys were generated for your OSDs in the storage cluster.
They are stored in the <strong>HashiCorp Vault</strong> instance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_granular_persistentvolume_at_rest_encryption"><a class="anchor" href="#_granular_persistentvolume_at_rest_encryption"></a>4. Granular <strong>PersistentVolume</strong> at-rest encryption</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use <strong>PersistentVolume</strong> encryption, it is required to setup a new storage class
that will be configured to use the external Key Management System we have configured in
the previous sectons of this guide.</p>
</div>
<div class="sect2">
<h3 id="_specific_storage_class"><a class="anchor" href="#_specific_storage_class"></a>4.1. Specific storage class</h3>
<div class="paragraph">
<p>Navigate to the <strong>Storage</strong> &#8594; <strong>Storage Classes</strong> menu.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/OCS4-4.7-OCP-Encryption-SCList.png" alt="OCP Storage Classes">
</div>
<div class="title">Figure 12. OCP Storage Classes</div>
</div>
<div class="paragraph">
<p>Click <code>Create Storage Class</code> in the top right of the UI.</p>
</div>
<div class="paragraph">
<p>Enter the details for your new storage class as detailed below.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/KMS-Vault-StorageClass.jpg" alt="Encrypted storage class details">
</div>
<div class="title">Figure 13. Encrypted Storage Class</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Specify the name of your storage class</p>
</li>
<li>
<p>Select the Ceph CSI RBD provisioner</p>
</li>
<li>
<p>Choose the Ceph pool receiving the PersistentVolumes</p>
</li>
<li>
<p>Enable encryption for this storage class and chose our existing KMS.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The pool can be the same as the default pool.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
CephFS based PV encryption is not yet available.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Click <code>Create</code> in the UI.</p>
</div>
</div>
<div class="sect2">
<h3 id="_test_application"><a class="anchor" href="#_test_application"></a>4.2. Test application</h3>
<div class="paragraph">
<p>Create a new project for your test application using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc new-project my-rbd-storage</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Now using project "my-rbd-storage" on server "https://api.ocp45.ocstraining.com:6443".

You can add applications to this project with the 'new-app' command. For example, try:

    oc new-app rails-postgresql-example

to build a new example application in Ruby. Or use kubectl to deploy a simple Kubernetes application:

    kubectl create deployment hello-node --image=k8s.gcr.io/serve_hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a secret to hold the vault access token specific to this project. Use the following template
to create the secret.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">---
apiVersion: v1
kind: Secret
metadata:
  name: ceph-csi-kms-token
  namespace: my-rbd-storage
stringData:
  token: "{application_vault_token}"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>{application_vault_token}</code> with a Vault token. For security purposes you should consider creating different tokens for every namespace. For development purposes you can use the ODF token you created above.</p>
</div>
<div class="paragraph">
<p>Deploy your application using the dedicated storage class you just created. Use the following command
to do so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cat &lt;&lt;EOF | oc create -f -
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-cephrbd1
  namespace: my-rbd-storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Gi
  storageClassName: encrypted-rbd
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: pvc-cephrbd2
  namespace: my-rbd-storage
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
  storageClassName: encrypted-rbd
---
apiVersion: batch/v1
kind: Job
metadata:
  name: batch2
  namespace: my-rbd-storage
  labels:
    app: batch2
spec:
  template:
    metadata:
      labels:
        app: batch2
    spec:
      restartPolicy: OnFailure
      containers:
      - name: batch2
        image: amazon/aws-cli:latest
        command: ["sh"]
        args:
          - '-c'
          - 'while true; do echo "Creating temporary file"; export mystamp=$(date +%Y%m%d_%H%M%S); dd if=/dev/urandom of=/mnt/file_${mystamp} bs=1M count=1; echo "Copying temporary file"; cp /mnt/file_${mystamp} /tmp/file_${mystamp}; echo "Going to sleep"; sleep 60; echo "Removing temporary file"; rm /mnt/file_${mystamp}; done'
        volumeMounts:
        - name: tmp-store
          mountPath: /tmp
        - name: tmp-file
          mountPath: /mnt
      volumes:
      - name: tmp-store
        persistentVolumeClaim:
          claimName: pvc-cephrbd1
          readOnly: false
      - name: tmp-file
        persistentVolumeClaim:
          claimName: pvc-cephrbd2
          readOnly: false
EOF</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">persistentvolumeclaim/pvc-cephrbd1 created
persistentvolumeclaim/pvc-cephrbd2 created
job.batch/batch2 created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify the status of the application and its different components.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc describe pod</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[...]
Volumes:
  tmp-store:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  pvc-cephrbd1
    ReadOnly:   false
  tmp-file:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  pvc-cephrbd2
    ReadOnly:   false
  default-token-rghg5:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-rghg5
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason                  Age    From                     Message
  ----     ------                  ----   ----                     -------
  Warning  FailedScheduling        8m45s  default-scheduler        0/6 nodes are available: 6 pod has unbound immediate PersistentVolumeClaims.
  Warning  FailedScheduling        8m45s  default-scheduler        0/6 nodes are available: 6 pod has unbound immediate PersistentVolumeClaims.
  Normal   Scheduled               8m42s  default-scheduler        Successfully assigned my-rbd-storage/batch2-n4cqv to ip-10-0-202-113.us-east-2.compute.internal
  Normal   SuccessfulAttachVolume  8m43s  attachdetach-controller  AttachVolume.Attach succeeded for volume "pvc-f884eadc-9d37-4111-85ea-123c78b646a7"
  Normal   SuccessfulAttachVolume  8m43s  attachdetach-controller  AttachVolume.Attach succeeded for volume "pvc-93affaed-40f4-4fba-b907-53fbeefbd03f"
  Normal   AddedInterface          8m24s  multus                   Add eth0 [10.128.2.19/23]
  Normal   Pulling                 8m23s  kubelet                  Pulling image "amazon/aws-cli:latest"
  Normal   Pulled                  8m23s  kubelet                  Successfully pulled image "amazon/aws-cli:latest" in 563.111829ms
  Normal   Created                 8m23s  kubelet                  Created container batch2
  Normal   Started                 8m23s  kubelet                  Started container batch2</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc get pvc</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">NAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE
pvc-cephrbd1   Bound    pvc-93affaed-40f4-4fba-b907-53fbeefbd03f   500Gi      RWO            encrypted-rbd   9m30s
pvc-cephrbd2   Bound    pvc-f884eadc-9d37-4111-85ea-123c78b646a7   500Mi      RWO            encrypted-rbd   9m30s</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also verify that the <strong>HashiCorp Vault</strong> scret engine now contains two PersistentVolume specific keys.</p>
</div>
<div class="paragraph">
<p>Open a remote shell on one of the Vault Pods</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc exec -ti vault-0 -n vault -- sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then login as the root, using the Token you got when initializing the Vault cluster</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault login</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Token (will be hidden):
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.t1yycIXXXXXXXX
token_accessor       qLxxdspcAYQoOnQsgquC6PY2
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>List all Keys in the <code>ocs</code> path.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">vault kv list ocs</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">Keys
---
0001-0011-openshift-storage-0000000000000001-c27dc662-9ae1-11ec-8efb-0a580a80020a
0001-0011-openshift-storage-0000000000000001-c28f1e08-9ae1-11ec-8efb-0a580a80020a
NOOBAA_ROOT_SECRET_PATH/
rook-ceph-osd-encryption-key-ocs-deviceset-gp2-0-data-08p9p4
rook-ceph-osd-encryption-key-ocs-deviceset-gp2-1-data-0bd4n5
rook-ceph-osd-encryption-key-ocs-deviceset-gp2-2-data-0pzgmq</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
When deleting your application make sure you delete your application pods and PVCs before
deleting the secret that contains your access token to the vault. If you fail to do so you will end up
with orphans PV keys in your vault.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_granular_persistentvolume_at_rest_encryption_without_cluster_wide_encryption_kubernetes_auth_method_serviceaccounts"><a class="anchor" href="#_granular_persistentvolume_at_rest_encryption_without_cluster_wide_encryption_kubernetes_auth_method_serviceaccounts"></a>5. Granular <strong>PersistentVolume</strong> at-rest encryption without cluster-wide encryption: Kubernetes Auth Method - ServiceAccounts</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The following steps will be supported and further integrated with ODF 4.10. Following the below steps on a cluster before 4.10 will most likely result in an unsupported configuration.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before ODF can use external Vault with service account tokens, we have to configure the authentcation method and Vault roles and policies. Details of the Kubernetes Authentication Method are out of scope for this document but are well explained by <a href="https://cloud.redhat.com/blog/vault-integration-using-kubernetes-authentication-method">Vault Integration Using Kubernetes Authentication Method</a>. In addition, Hashicorp Vault provides tutorials on general <a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault?in=vault/kubernetes">integration between Vault and Kubernetes</a>.</p>
</div>
<div class="paragraph">
<p>This section outlines steps for using an external Vault instance with the following configuration options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vault instance external the Openshift cluster</p>
</li>
<li>
<p>Openshift ServiceAccount token is used to authenticate with Vault via the Kubernetes Authentication method</p>
</li>
<li>
<p>Vault namespace for reading/writing secrets used for encryption (optional)</p>
</li>
<li>
<p>Secrets engine not enabled under Vault namespace but to a different path (optional)</p>
</li>
<li>
<p>Vault Backend is kv v2 (optional)</p>
</li>
<li>
<p>HTTPS (optional)</p>
</li>
<li>
<p>Vault Certificate Authority verified (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please gather the following information and verify the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Your <strong>Vault Address</strong> (i.e. <a href="http://vault.myvault.com:8200" class="bare">vault.myvault.com:8200</a>)</p>
</li>
<li>
<p>Ensure your <strong>Vault instance</strong> has access to your <strong>cluster api endpoint</strong>.</p>
</li>
<li>
<p>Access to configure <strong>Vault auth, policies and secrets engine enablement</strong> or via a Vault administrator.</p>
</li>
<li>
<p>If you are verifying the <strong>Vault CA certificate</strong>, please have your Vault CA cert (PEM) available as you will need to base64 encode this cert in a secret. Detailed steps below.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_serviceaccounts_bindings_and_roles"><a class="anchor" href="#_serviceaccounts_bindings_and_roles"></a>5.1. ServiceAccounts, bindings and roles</h3>
<div class="paragraph">
<p>Setup for using Kubernetes Authentication method must be configured before ODF can authenticate with and start using Vault. The instructions below create and configure ServiceAccounts, ClusterRole and ClusterRoleBinding required to allow ODF default ServiceAccount to authenticate with Vault.</p>
</div>
<div class="paragraph">
<p>Apply the following to your Openshift cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rbd-csi-vault-token-review
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rbd-csi-vault-token-review
rules:
  - apiGroups: ["authentication.k8s.io"]
    resources: ["tokenreviews"]
    verbs: ["create", "get", "list"]

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rbd-csi-vault-token-review
subjects:
  - kind: ServiceAccount
    name: rbd-csi-vault-token-review
    namespace: default
  - kind: ServiceAccount
    name: default
    namespace: openshift-storage
  - kind: ServiceAccount
    name: rook-csi-rbd-plugin-sa
    namespace: openshift-storage
  - kind: ServiceAccount
    name: rook-csi-rbd-provisioner-sa
    namespace: openshift-storage
roleRef:
  kind: ClusterRole
  name: rbd-csi-vault-token-review
  apiGroup: rbac.authorization.k8s.io</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configureverify_vault_authentication"><a class="anchor" href="#_configureverify_vault_authentication"></a>5.2. Configure/Verify Vault Authentication</h3>
<div class="paragraph">
<p>As mentioned in the previous step, setup for using Kubernetes Authentication method must be configured before ODF can authenticate with and start using Vault. In addition to the previous step, ensure Vault has the right roles and policies created by apply the steps below.</p>
</div>
<div class="paragraph">
<p>The steps below assume you have root access to Vault. If you do not have root access to Vault (i.e. Vault is administered by another team) please forward these instructions to your Vault administrator.</p>
</div>
<div class="listingblock">
<div class="title">Apply the following to your cluster:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: rbd-csi-vault-token-review-psp
spec:
  fsGroup:
    rule: RunAsAny
  runAsUser:
    rule: RunAsAny
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
    - 'configMap'
    - 'secret'

---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: openshift-storage
  name: rbd-csi-vault-token-review-psp
rules:
  - apiGroups: ['policy']
    resources: ['podsecuritypolicies']
    verbs: ['use']
    resourceNames: ['rbd-csi-vault-token-review-psp']

---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rbd-csi-vault-token-review-psp
  namespace: openshift-storage
subjects:
  - kind: ServiceAccount
    name: rbd-csi-vault-token-review
    namespace: openshift-storage
roleRef:
  kind: Role
  name: rbd-csi-vault-token-review-psp
  apiGroup: rbac.authorization.k8s.io</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configureverify_vault_policies_for_odf"><a class="anchor" href="#_configureverify_vault_policies_for_odf"></a>5.3. Configure/Verify Vault Policies for ODF</h3>
<div class="paragraph">
<p>The following step requires customization to your exact environment. Please do not apply to your cluster until after making all necessary changes. Details for each configuration option are below.</p>
</div>
<div class="listingblock">
<div class="title">Apply the following for psp, role, and Vault setup configuration:</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: v1
kind: Service
metadata:
  name: vault
  labels:
    app: vault-api
spec:
  ports:
    - name: vault-api
      port: 8200
  clusterIP: None
  selector:
    app: vault
    role: server

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault
  labels:
    app: vault
    role: server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault
      role: server
  template:
    metadata:
      labels:
        app: vault
        role: server
    spec:
      containers:
        - name: vault
          image: docker.io/library/vault:latest
          imagePullPolicy: "IfNotPresent"
          securityContext:
            runAsUser: 100
          env:
            - name: VAULT_DEV_ROOT_TOKEN_ID
              value: sample_root_token <i class="conum" data-value="1"></i><b>(1)</b>
            - name: SKIP_SETCAP
              value: any
          livenessProbe:
            exec:
              command:
                - pidof
                - vault
            initialDelaySeconds: 5
            timeoutSeconds: 2
          ports:
            - containerPort: 8200
              name: vault-api
---
apiVersion: v1
items:
  - apiVersion: v1
    data:
      init-vault.sh: |
        set -x -e

        timeout 300 sh -c 'until vault status; do sleep 5; done'

        # login into vault to retrieve token
        vault login ${VAULT_DEV_ROOT_TOKEN_ID}

        # enable kubernetes auth method under specific path:
        vault auth enable -path="/${CLUSTER_IDENTIFIER}" kubernetes

        # write configuration to use your cluster
        vault write auth/${CLUSTER_IDENTIFIER}/config \
          token_reviewer_jwt=@${SERVICE_ACCOUNT_TOKEN_PATH}/token \
          kubernetes_host="${K8S_HOST}" \
          kubernetes_ca_cert=@${SERVICE_ACCOUNT_TOKEN_PATH}/ca.crt

        # create policy to use keys related to the cluster
        vault policy write "${CLUSTER_IDENTIFIER}" - &lt;&lt; EOS
        path "secret/data/ceph-csi/*" {
          capabilities = ["create", "update", "delete", "read", "list"]
        }

        path "secret/metadata/ceph-csi/*" {
          capabilities = ["read", "delete", "list"]
        }

        path "sys/mounts" {
          capabilities = ["read"]
        }
        EOS

        # create a role
        vault write "auth/${CLUSTER_IDENTIFIER}/role/${PLUGIN_ROLE}" \
            bound_service_account_names="${SERVICE_ACCOUNTS}" \
            bound_service_account_namespaces="${SERVICE_ACCOUNTS_NAMESPACE}" \
            kubernetes_ca_cert=@${SERVICE_ACCOUNT_TOKEN_PATH}/ca.crt \
            policies="${CLUSTER_IDENTIFIER}"

        # disable iss validation
        # from: external-secrets/kubernetes-external-secrets#721
        vault write auth/kubernetes/config \
          kubernetes_host="${K8S_HOST}" \
          kubernetes_ca_cert=@${SERVICE_ACCOUNT_TOKEN_PATH}/ca.crt \
          disable_iss_validation=true
    kind: ConfigMap
    metadata:
      creationTimestamp: null
      name: init-scripts
kind: List
metadata: {}

---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init-job
spec:
  parallelism: 1
  completions: 1
  template:
    metadata:
      name: vault-init-job
    spec:
      serviceAccount: rbd-csi-vault-token-review
      volumes:
        - name: init-scripts-volume
          configMap:
            name: init-scripts
      containers:
        - name: vault-init-job
          image: docker.io/library/vault:latest
          volumeMounts:
            - mountPath: /init-scripts
              name: init-scripts-volume
          env:
            - name: HOME
              value: /tmp
            - name: CLUSTER_IDENTIFIER
              value: kubernetes
            - name: SERVICE_ACCOUNT_TOKEN_PATH
              value: /var/run/secrets/kubernetes.io/serviceaccount
            - name: K8S_HOST
              value: https://{your_openshift_APIServer_external_endpoint} <i class="conum" data-value="2"></i><b>(2)</b>
            - name: PLUGIN_ROLE
              value: csi-kubernetes
            - name: SERVICE_ACCOUNTS
              value: rbd-csi-nodeplugin,rbd-csi-provisioner,csi-rbdplugin,csi-rbdplugin-provisioner,rook-csi-rbd-provisioner-sa,rook-csi-rbd-plugin-sa
            - name: SERVICE_ACCOUNTS_NAMESPACE
              value: openshift-storage
            - name: VAULT_ADDR
              value: {your_vault_url} <i class="conum" data-value="3"></i><b>(3)</b>
            - name: VAULT_DEV_ROOT_TOKEN_ID
              value: sample_root_token <i class="conum" data-value="1"></i><b>(1)</b>
          command:
            - /bin/sh
            - /init-scripts/init-vault.sh
          imagePullPolicy: "IfNotPresent"
      restartPolicy: Never</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace with a Vault token that allows policy creation. This token is only used during Vault configuration and may be revoked after the job above completes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace with your Openshift API server external endpoint. (i.e. <a href="https://api.ocp47.myopenshift.com:6443" class="bare">api.ocp47.myopenshift.com:6443</a>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace with your vault url. (i.e. <a href="http://vault.myvault.com:8200/" class="bare">vault.myvault.com:8200/</a>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Verify the job in the yaml above completed without error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc -n openshift-storage get pods | grep vault-init
oc -n openshift-storage logs pods/{POD from previous command}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_an_encrypted_storageclass"><a class="anchor" href="#_create_an_encrypted_storageclass"></a>5.4. Create an Encrypted StorageClass</h3>
<div class="paragraph">
<p>In order to create a storageclass that uses our external Vault, we must create and configure a configmap named csi-kms-connection-details that will hold all the information needed to establish the connect. Our storageclass needs to contain the field "encryptionKMSID" whose value is used as a lookup into cm/csi-kms-connection-details.</p>
</div>
<div class="paragraph">
<p>Create the csi-kms-connection-detail configmap by applying the yaml below. If you change "vault-test" to a more meaningful name for your environment please do not forget to also use your new name in the storageclass encryptionKMSID field in your new storageclass.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: v1
kind: ConfigMap
data:
  vault-test : |- <i class="conum" data-value="1"></i><b>(1)</b>
    {
      "encryptionKMSType": "vault",
      "vaultAddress": "{URL to your vault address, http or https, and port}", <i class="conum" data-value="2"></i><b>(2)</b>
      "vaultAuthPath": "/v1/auth/kubernetes/login",
      "vaultRole": "csi-kubernetes",
      "vaultPassphraseRoot": "/v1/secret",
      "vaultPassphrasePath": "ceph-csi/",
      "vaultCAVerify": "true" <i class="conum" data-value="3"></i><b>(3)</b>
    }
metadata:
  name: csi-kms-connection-details</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You may change vault-test to a more meaningful name for your environment. Just remember to use the same value for encryptionKMSID in your StorageClass.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace with your Vault URL.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Change to "false" if your Vault CA should not be verified.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a StorageClass that uses the service account for authentication.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">allowVolumeExpansion: false
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: {NEW STORAGECLASS NAME} <i class="conum" data-value="1"></i><b>(1)</b>
parameters:
  clusterID: openshift-storage
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/controller-expand-secret-namespace: openshift-storage
  csi.storage.k8s.io/fstype: ext4
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: openshift-storage
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: openshift-storage
  encrypted: "true"
  encryptionKMSID: vault-test <i class="conum" data-value="2"></i><b>(2)</b>

  imageFeatures: layering
  imageFormat: "2"
  pool: ocs-storagecluster-cephblockpool
provisioner: openshift-storage.rbd.csi.ceph.com
reclaimPolicy: Delete
volumeBindingMode: Immediate</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace with what you would like to call your new storageclass.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Make sure this value matches the entry in cm/csi-kms-connection-details you want this storageclass to use. See item 1 in the yaml for cm/csi-kms-connect-details above.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_pvc_using_this_storageclass"><a class="anchor" href="#_create_a_pvc_using_this_storageclass"></a>5.5. Create a PVC using this StorageClass</h3>
<div class="paragraph">
<p>Apply the following to create PVC using your new storageclass that uses the Kubernetes Auth Method with Vault:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {PVC NAME} <i class="conum" data-value="1"></i><b>(1)</b>
  namespace: {YOUR NAMESPACE} <i class="conum" data-value="2"></i><b>(2)</b>
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: {NEW STORAGECLASS NAME} <i class="conum" data-value="3"></i><b>(3)</b>
  volumeMode: Filesystem</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name your new PVC</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace with your desired namespace</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace with the storageclass name you previously created.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Your PVC should bind within seconds. If your PVC is stuck in Pending review the events and logs for possible reasons. Look for mismatches between namespace, sa and Vault policy and role.</p>
</div>
<div class="paragraph">
<p>If you need to troubleshoot, try these steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">oc -n openshift-storage run tmp --rm -i --tty  --serviceaccount=rook-csi-rbd-plugin-sa --image ubi8:latest</code></pre>
</div>
</div>
<div class="paragraph">
<p>To start a container with attached SA <code>rook-csi-rbd-plugin-sa</code>. Install <code>jq</code> (yum install jq) and run the following to verify the <code>rook-csi-rbd-plugin-sa</code> can retrieve a vault client token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">export VAULT_ADDR={VAULT ADDR i.e. https://vault.myvault.com:8200}
export KUBE_TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
export VT=$(curl -s --request POST --data '{"jwt": "'"$KUBE_TOKEN"'", "role": "csi-kubernetes"}' $VAULT_ADDR/v1/auth/kubernetes/login | jq -r '.auth.client_token')
echo $VT</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the last command above did not return any value, there is a mismatch between the SA and namespace the pod is running as, and how the Vault policy was configured. Double check your configuration for typos.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <a class="navbar-item" href="https://www.redhat.com/en/technologies/cloud-computing/openshift-container-storage" target="_blank">
      <img src="../../_/img/header_logo.svg" alt="Red Hat Data Services">
  </a>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
